<!DOCTYPE html>
<html lang="en-us">

  <head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <meta name="description" content="Jeremy Cochoy's personal website.">
  <meta name="author" content="Jeremy Cochoy">

  <title>
    
      ATMega328 (Arduino uno) TimerCounter et PWM √† 62,5kHz &middot; Jeremy Cochoy
    
  </title>

  <!-- CSS -->
  <link href="/public/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
  	<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <!-- Custom styles for this template -->
  <link href="/public/style.css" rel="stylesheet">

  <!-- Maths equations -->
  <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      processEscapes: true
    }
  });
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
</head>


  <body>

    <!-- Fixed navbar -->
<nav class="navbar navbar-default navbar-fixed-top">
 <div class="container">
   <div class="navbar-header">
     <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
 <span class="sr-only">Toggle navigation</span>
 <span class="icon-bar"></span>
 <span class="icon-bar"></span>
 <span class="icon-bar"></span>
     </button>
     <a class="navbar-brand" href="/">Jeremy Cochoy</a>
   </div>
   <div id="navbar" class="collapse navbar-collapse">
     <ul class="nav navbar-nav">
     <li><a href="/resume/">Resume</a></li>
 <li><a href="/blog/">Blog</a></li>
 <li role="separator" class="divider"></li>
 <li><a href="/talks/">Talks</a></li>
 <li><a href="/research/">Research</a></li>
 <li><a href="/teaching/">Teaching</a></li>
 <li><a href="/music/">Music</a></li>
 <li class="dropdown">
   <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">More <span class="caret"></span></a>
   <ul class="dropdown-menu">
     <li><a href="/hyper-flop/">Hyper-Flop</a></li>
     <li role="separator" class="divider"></li>
     <li><a href="/pdfs/">PDFs & Talks</a></li>
     <li><a href="/agreg-dev/">Agregation de math√©matique</a></li>
     <li role="separator" class="divider"></li>
     <li><a href="https://github.com/jeremycochoy/sednl" alt="SEDNL Github">SEDNL (Github)</a></li>
     <li><a href="http://sednl.zenol.fr" alt="Simple Event Driven Network Library">SEDNL</a></li>
           <li role="separator" class="divider"></li>
           <li><a href="/gb-doc">GameBoy Emulator Documentation</a></li>
   </ul>
 </li>
     </ul>
   </div><!--/.nav-collapse -->
 </div>
</nav>


    <div class="container">
      <div class="post">
  <h1 class="post-title">ATMega328 (Arduino uno) TimerCounter et PWM √† 62,5kHz</h1>
  <span class="post-date">30 Apr 2012</span>
  <h2 id="timercounter-et-pwm-pour-des-fr√©quences-√©lev√©s">Timer/Counter et PWM pour des fr√©quences √©lev√©s.</h2>

<p>Cette article traite de l‚Äôutilisation de certaines fonctionnalit√©s de l‚ÄôATMega328P qui peuvent s‚Äôav√©rer utiles pour le traitement des signaux audio (par exemple, r√©aliser une p√©dale d‚Äôeffet), jouer des samples de musique (√©chantillonn√©s √† 44100Hz ou moins), ou encore r√©aliser de la synth√®se sonore.</p>

<p>Il est question d‚Äôaborder ici le stricte minimum pour utiliser le PWM (Pulse Width Modulation) √† une fr√©quence suffisamment √©lev√© affin de pouvoir g√©n√©rer un signale analogique et de contr√¥ler son amplitude. En bonus, nous pourrons ex√©cuter une interruption toute les 16uS.</p>

<p>Je recommande fortement au gens aillant un peut d‚Äôexp√©rience de lire directement la documentation relative aux Timers/Counters, PWM, et aux registres DDRx/PORTx.</p>

<h3 id="timer-et-pwm">Timer et PWM</h3>

<p>L‚ÄôATMega328P comprend 3 Timers, c‚Äôest √† dire trois compteurs qui sont incr√©ment√© par le microcontroleur tout les N ticks d‚Äôhorloges (K peut valoir 1, 8, 32, 64, 256, 1024 celons vos envies). Ces timers se noment ‚ÄúTimer0‚Äù, ‚ÄúTimer1‚Äù et ‚ÄúTimer2‚Äù.¬† Le Timer0 est utilis√© par la biblioth√®que arduino pour √©valuer l‚Äô√©coulement du temps (delay, microsecond) et pour les sorties PWM associ√©s √† ce timer. Le Timer1 dispose d‚Äôun compteur 16bits, c‚Äôest √† dire de 0 √† 0xFFFF, alors que les timers 2 et 1 sont en 8bits (de 0 √† 0xFF). L‚Äôid√©e est que nous voulons compter vite, tr√®s vite, donc nous avons int√©ret √† utiliser un compteur 8bits. Notre choix se port donc tout naturellement sur le timer2.</p>

<p>Le PWM correspond √† la mise sous tension d‚Äôune patte de l‚ÄôATMega durant un certain laps de temps, puis de sa mise √† 0 durant un autre instant, et le tout r√©p√©t√© tr√®s rapidement. Cela permet de simuler un signale analogique de tension comprise entre 5v et 0v (Moins si vous n‚Äôutilisez pas l‚Äôalimentation 5V). Le principe est tr√®s bien d√©crit par le sch√©ma suivant provenant du site d‚Äôarduino(http://arduino.cc/en/Tutorial/PWM) :</p>

<p><img src="data/pwm.gif" alt="PWM on Arduino" /></p>

<p>Il faut savoir que chaque Timer controle deux sorties PWM. Les pattes correspondant √† ces sorties sont indiqu√© sur la page 2 de la documentation atmel (OCnA et OCnB, o√π n est le num√©ro du timer). Dans notre cas nous utiliseront la sortie OC2A, qui correspond au pin 11 d‚Äôune carte arduino.</p>

<p>Le fonctionnement du PWM est extr√™mement simple ; Vous r√©glez le PWM avec une valeur comprise entre 0 et 255, disons C. Alors, tant que le compteur est plus petit que C, il y auras une tension de 5V sur la sortie OC2A. Quand le compteur d√©passe C, la tension passe √† 0V. Pour acc√©l√©rer une sortie PWM, il faut donc acc√©l√©rer le timer qui est associ√©.</p>

<h3 id="le-mode-fastpwm-atmega328p-datasheet-p152-153">Le mode FastPWM (ATMega328P datasheet p152-153)</h3>

<p>Il existe plusieurs configurations possible pour la sortie PWM, la fr√©quence des timers, etc. Je vous conseille tr√®s fortement de lire la documentation atmel √† ce sujet. Dans notre cas, nous cherchons la plus rapide, et il y en a une qui correspond tout √† fait √† nos besoins ; La configuration Fast PWM.</p>

<p>Le compteur que nous avons √©voqu√©, associ√© au Timer2, se nome ‚ÄúTCNT2‚Äù(Timer Counter 2), et peut √™tre lut et √©crit √† tout moment. La valeur √† partir de la quel le signal bascule de 5V √† 0V est stock√© dans OCR2A(Output Compare Register 2 A). Un second registre de comparaison est disponible, OCR2B, et correspond au pin OC2B.</p>

<p>Dans ce mode, le comTCNT2 part de 0, puis atteint progressivement OCR2A. Alors, la tension de sortie de OC2A s‚Äôinverse. √Ä cette instant, une interruption peut √™tre d√©clench√©e. C‚Äôest √† dire, si vous n‚Äô√™tes pas familier avec ce m√©canisme, qu‚Äôune fonction que vous aurez pr√©alablement √©crite, compil√©, et associ√© √† ce m√©canisme, seras ex√©cut√©. De m√™me pour OCR2B/OC2B.</p>

<p>Le compteur continus sa mont√©e, et atteint alors 0xFF. Il y a alors overflow : le compteur repasse √† 0x00 √† la prochaine incr√©mentation, et enclenche l‚Äôinterruption TIMER2_OVF (Timer 2 Overflow), si elle est activ√©e.</p>

<p>Sachez enfin que vous pouvez configurer si la tension de sortie avant que le compteur atteigne OCR2A doit √™tre haute ou basse. Nous choisirons qu‚Äôelle est haute, puis basse. De cette fa√ßon, si OCR2A = 0, la tension sera 0 sur une p√©riode (16us, pour m√©moire), et si OCR2A = 0xFF, elle sera de 5V (toujours sur une p√©riode).</p>

<p>Le sch√©ma suivant, issu de la documentation, d√©crit une succession d‚Äôinterventions sur le registre OCR2A, l‚Äô√©volution du compteur, le d√©clenchement des interruptions, et les tensions de sorties(haut pour 5V et bas pour 0V) celons la configuration des deux bits COM2A1 et COM2A0 (Pour les valeur 2( = 1 0 en binaire) et 3 = (1 1 en binaire))</p>

<p><img src="data/FastPWM_Atmel_atmega38p.png" alt="FastPWM Atmel ATMega328p" /></p>

<p>La fr√©quence √† la quel l‚Äôinterruption TOV2(TIMER2<em>OVF) est appel√© se calcul ais√©ment √† partir de celle de l‚Äôhorloge de l‚ÄôATMega. Si vous utilisez un quartz externe √† 16MHz (c‚Äôest le cas des cartes arduino) la fr√©quence est alors $\frac{f</em>{clock}}{N . 256}$ o√π $N$ est le facteur d‚Äô√©chelle (prescale factor), dont nous parlerons un peu plus loin.</p>

<p>L‚Äôactivation du mode FastPWM (p160 de la documentation) se fait en fixant les bits du ‚ÄúTimer Counter Control Register‚Äù¬† A et B (TCCR2A et TCCR2B).</p>

<p>Le premier contient le type de sortie COM2A1:0 et COM2B1:0, ainsi que les bits WGM21 WMGM20 contr√¥lant le mode de l‚Äôhorloge.¬† Le second (p163)¬† contient le dernier bit de configuration du mode, WGM22 et les trois bits permettant de s√©lectionner le facteur d‚Äô√©chelle (dans notre cas, nous choisirons 1, pour que la fr√©quence soit la plus √©lev√©) ; CS22, CS21, CS20.</p>

<p>Ainsi, nous pouvons d√©j√† configurer le mode Fast PWM :</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">TTCCR2A</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">COM2A1</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WGM01</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WGM00</span><span class="p">;</span>
<span class="n">TTCCR2B</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">WGM02</span> <span class="o">|</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">CS22</span> <span class="o">|</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">CS21</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CS20</span><span class="p">;</span>
</code></pre></div></div>
<p>Nb : Sachez que pour chacun des modes, vous trouverez un tel sch√©ma dans la documentation :)</p>

<h3 id="facteur-d√©chelle">Facteur d‚Äô√©chelle</h3>

<p>Les bits CS22, CS21 et CS20 permettent de configurer le facteur d‚Äô√©chelle.
Le concept est simple (p155 et p156 de la documentation pour des sch√©ma
extr√™mement claires) ; le compteur TCNT2 seras incr√©ment√© de 1 tout
les N ticks d‚Äôhorloge, o√π la valeur de n d√©pend du facteur d‚Äô√©chelle choisit,
d‚Äôapr√®s le tableau suivant (p164 de la documentation) :</p>

<p><img src="data/csb_desc.png" alt="Clock Select Bit Description" /></p>

<h3 id="activer-la-sortie-pwm">Activer la sortie PWM</h3>

<p>Nous avons donc configurer le compteur, et la sortie PWM peut maintenant √™tre utilis√©e. Mais encore faut-il l‚Äôactiver. Pour cela, il faut s√©lectionner la ‚Äúdirection‚Äù du pin associ√© au comparateur A (OC2A) comme ‚ÄúOUTPUT‚Äù. Cela se fait via le Data Direction Register B (car la sortie OC2A est la troisi√®me patte du port B, c‚Äôest √† dire la sortie 11 de la carte arduino).</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DDRB</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DDB3</span><span class="p">;</span>
</code></pre></div></div>
<p>Pour d√©sactiver la sortie PWM lorsque le pin est toujours en mode output, il suffit de modifier la valeur de COM2A.</p>

<h3 id="utiliser-les-interruptions">Utiliser les interruptions</h3>

<p>Le dernier outil, pour pouvoir par exemple effectuer une acquisition audio √†¬† $31,25kHz$, est interruption OVF, d√©clench√©e d√®s que le compteur passe de 0xFF √† 0x00.¬† Pour ce faire, il faut informer le compilateur que votre fonction doit √™tre associ√© √† une interruption, et activer l‚Äôinterruption gr√¢ce au masque d‚Äôinterruption TIMSK2.</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Configuration</span>
<span class="n">TIMSK2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TOIE2</span><span class="p">;</span>

<span class="c1">// ...</span>

<span class="n">ISR</span><span class="p">(</span><span class="n">TIMER2_OVF_vect</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// Code de l'interruption</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="la-biblioth√®que-c-avr">La biblioth√®que C AVR</h3>

<p>Si nous pouvons utiliser toute ces macros, c‚Äôest bien quelles sont d√©finit quelques part. Il s‚Äôagit d‚Äôune biblioth√®que C permettant de d√©velopper sur les microcontroleurs atmel en C. Cette biblioth√®que contient une documentation dont je recommande chaudement la lecture, notamment pour ceux qui souhaiterais diminuer le temps perdu en ent√™te C dans l‚Äôinterruption OVF (environs 20 √† ticks d‚Äôhorloge √† 16MHz, ce qui repr√©sente tout de m√™me 20 √† 30 256i√®me du temps d‚Äôex√©cution de votre microcontroleur!)</p>

<p>Sachez aussi qu‚Äôune fa√ßon plus agr√©able d‚Äô√©crire (1 ¬´¬†ABCD) est _BV(ABCD).</p>

<h3 id="r√©f√©rences">R√©f√©rences:</h3>

<ul>
  <li>La biblioth√®que C AVR (Interruptions) : <a href="http://www.nongnu.org/avr-libc/user-manual/group__avr__interrupts.html">http://www.nongnu.org/avr-libc/user-manual/group__avr__interrupts.html</a></li>
  <li>Atmel ATMega328 Datasheet : <a href="http://www.atmel.com/images/atmel-8271-8-bit-avr-microcontroller-atmega48a-48pa-88a-88pa-168a-168pa-328-328p_datasheet_summary.pdf">http://www.atmel.com/images/atmel-8271-8-bit-avr-microcontroller-atmega48a-48pa-88a-88pa-168a-168pa-328-328p_datasheet_summary.pdf</a></li>
  <li>Realtime Audio Processing de Martin Nawrath : <a href="http://interface.khm.de/wp-content/uploads/2008/10/arduino_realtime_audio_eng.pdf">http://interface.khm.de/wp-content/uploads/2008/10/arduino_realtime_audio_eng.pdf</a></li>
  <li>PWM : <a href="http://arduino.cc/en/Tutorial/PWM">http://arduino.cc/en/Tutorial/PWM</a></li>
</ul>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/list-zipper-swift/">
            List Zipper applied to iOS swift
            <small>24 May 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/what-is-wrong-with-the-object-paradigm/">
            What is wrong with the object paradigm ?
            <small>17 Feb 2017</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/boost-property-tree/">
            How to use boost::property_tree to load and write JSON
            <small>21 Dec 2015</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

    
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-10762787-1', 'auto');
    ga('send', 'pageview');
</script>
    

    <footer class="footer">
  <hr/>
  <div class="container">
    <div class="row">
      <p class="text-muted col-sm-10 text-center">
            <span class="sidebar-nav-item small">Make a donation. üòá</span>
            <span class="sidebar-nav-item x-small">BTC: <a href="bitcoin:1JcME7DSCw8b83nEGFKUYTKE4LM8aX4dhJ">1JcME7DSCw8b83nEGFKUYTKE4LM8aX4dhJ</a></span>
            <span class="sidebar-nav-item x-small">ETH: <a href="ethereum:eA22ADf19f20D618D8EF66E4704C540A10708F1F">eA22ADf19f20D618D8EF66E4704C540A10708F1F</a></span>
      </p>
      <p class="col-sm-2">
        <a class="twitter-share-button col-sm"
           href="https://twitter.com/share"
           data-via="Zenol42">
          Tweet
        </a>
      </p>
    </div>
  </div>
</footer>

<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/bootstrap/js/vendor/jquery.min.js"><\/script>')</script>
<script src="/public/bootstrap/js/bootstrap.min.js"></script>

<!-- Twitter sharing button loader -->
<script>
  window.twttr = (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0],
      t = window.twttr || {};
    if (d.getElementById(id)) return t;
    js = d.createElement(s);
    js.id = id;
    js.src = "https://platform.twitter.com/widgets.js";
    fjs.parentNode.insertBefore(js, fjs);

    t._e = [];
    t.ready = function(f) {
      t._e.push(f);
    };

    return t;
  }(document, "script", "twitter-wjs"));
</script>

  </body>
</html>
