<!DOCTYPE html>
<html lang="en-us">

  <head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <meta name="description" content="Jeremy Cochoy's personal website.">
  <meta name="author" content="Jeremy Cochoy">

  <title>
    
      CMake - Mini howto &middot; Jeremy Cochoy
    
  </title>

  <!-- CSS -->
  <link href="/public/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
  	<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <!-- Custom styles for this template -->
  <link href="/public/style.css" rel="stylesheet">

  <!-- Maths equations -->
  <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      processEscapes: true
    }
  });
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
</head>


  <body>

    <!-- Fixed navbar -->
<nav class="navbar navbar-default navbar-fixed-top">
 <div class="container">
   <div class="navbar-header">
     <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
 <span class="sr-only">Toggle navigation</span>
 <span class="icon-bar"></span>
 <span class="icon-bar"></span>
 <span class="icon-bar"></span>
     </button>
     <a class="navbar-brand" href="/">Jeremy Cochoy</a>
   </div>
   <div id="navbar" class="collapse navbar-collapse">
     <ul class="nav navbar-nav">
     <li><a href="/resume/">Resume</a></li>
 <li><a href="/blog/">Blog</a></li>
 <li role="separator" class="divider"></li>
 <li><a href="/talks/">Talks</a></li>
 <li><a href="/research/">Research</a></li>
 <li><a href="/teaching/">Teaching</a></li>
 <li><a href="/music/">Music</a></li>
 <li class="dropdown">
   <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">More <span class="caret"></span></a>
   <ul class="dropdown-menu">
     <li><a href="/hyper-flop/">Hyper-Flop</a></li>
     <li role="separator" class="divider"></li>
     <li><a href="/pdfs/">PDFs & Talks</a></li>
     <li><a href="/agreg-dev/">Agregation de math√©matique</a></li>
     <li role="separator" class="divider"></li>
     <li><a href="https://github.com/jeremycochoy/sednl" alt="SEDNL Github">SEDNL (Github)</a></li>
     <li><a href="http://sednl.zenol.fr" alt="Simple Event Driven Network Library">SEDNL</a></li>
           <li role="separator" class="divider"></li>
           <li><a href="/gb-doc">GameBoy Emulator Documentation</a></li>
   </ul>
 </li>
     </ul>
   </div><!--/.nav-collapse -->
 </div>
</nav>


    <div class="container">
      <div class="post">
  <h1 class="post-title">CMake - Mini howto</h1>
  <span class="post-date">30 Jun 2013</span>
  <h2 id="quest-ce-que-cmake-">Qu‚Äôest-ce que CMake ?</h2>

<p>CMake est un utilitaire permettant de g√©n√©rer le ‚Äúbuild process‚Äù d‚Äôun projet. C‚Äôest un outils du m√™me genre que les autotools (aussi appel√© pour des raisons que je tairai ‚Äòautohell‚Äô) en</p>

<ul>
  <li>Plus simple √† configurer</li>
  <li>Plus r√©cent (donc moins de fa√ßons de proc√©d√© obscures)</li>
  <li>Plus performant (dans le sens o√π, avec cmake, compiler un projet √† l‚Äôext√©rieur du repository est extr√™mement simple et agr√©able!)</li>
  <li>Vous √™tes libre d‚Äôorganiser vos r√©pertoires/fichier comme vous le d√©sirez.</li>
</ul>

<p>Il est bon aussi de savoir que CMake est capable de g√©n√©rer aussi bien des Makefiles que des fichiers de projet VC++ ou XCode (pas mal, hein?).</p>

<p>On a aussi une jolie progression en % de la compilation (et l‚Äôon peut toujours utiliser make -j42 pour faire chauffer les c≈ìurs).</p>

<p>##Comment on s‚Äôen sert ?</p>

<p>On connais tous le <em>./autogen.sh</em>, <em>./configure</em> puis <em>make &amp;&amp; sudo make install</em>. Bien entendu, on produit tous les fichiers bien salle dans le dossier des sources, ce qui donne une magnifique liste de fichiers √† ajouter au .gitignore du votre projet (ou tout autre fichier √©quivalent pour svn / mercurial). Avec cmake, on peut reproduire le sch√©ma des autotools via <code class="language-plaintext highlighter-rouge">cmake .</code> puis <code class="language-plaintext highlighter-rouge">make &amp;&amp; sudo make install</code>. Mais mieux, vous pouvez (par exemple) faire <code class="language-plaintext highlighter-rouge">mkdir build &amp;&amp; cd build</code> puis <code class="language-plaintext highlighter-rouge">cmake ..</code> et <code class="language-plaintext highlighter-rouge">make &amp;&amp; sudo make install</code>. Dite bonjour a la propret√© de votre projet gr√¢ce √† CMake ;)</p>

<p>##Comment √ßa fonctionne ?</p>

<p>C‚Äôest l√† qu‚Äôest le plus beau. Configurer CMake pour un projet, g√©rer les d√©pendances de libs, g√©n√©rer les libs, voir m√™me g√©n√©rer les packages (que ce soit des packages archlinux, debian ‚Ä¶). On prend tr√®s vite en main, c‚Äôest claire, et la documentation est excellente.</p>

<p>Je ne vais pas d√©tailler comment construire un fichier de config ; le <a href="http://www.cmake.org/cmake/help/cmake_tutorial.html">tutorial CMake</a> le fait d√©j√† tr√®s bien, et l‚Äôon trouve tout ce qu‚Äôil manque dans le wiki. (Notez que dans un VRAI projet, il vous faudra un peu plus que le tutorial). Je vais aborder les id√©es g√©n√©rales et les petites astuces qui m‚Äôont servies.</p>

<p>D‚Äôabord, on place les instructions dans un fichier CMakeLists.txt a la racine du projet. On √©vite donc la multiplication des fichiers de configuration. Il est possible d‚Äôappeler des scripts d‚Äôautres dossier gr√¢ce √† <code class="language-plaintext highlighter-rouge">add_subdirectory("${PROJECT_SOURCE_DIR}/your_folder"</code>). Il est important d‚Äôutiliser <code class="language-plaintext highlighter-rouge">${PROJECT_SOURCE_DIR}</code> pour que tout se place bien quand on souhaite compiler dans un autre dossier.</p>

<p>On peut facilement demander a cmake de trouver des libs. En r√®gle g√©n√©rale, on trouve un FindNomDeLaLib.cmake que l‚Äôon placera dans projet/cmake/Modules/, et l‚Äôon prendras soin d‚Äôajouter <code class="language-plaintext highlighter-rouge">set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} "${CMAKE_SOURCE_DIR}/cmake/Modules/")</code>.</p>

<p>Une fa√ßon pratique pour compiler votre projet est de placer tous vos .c/.cpp dans un dossier src, et de tous les s√©lectionner (√ßa √©vite d‚Äôoublier d‚Äôajouter un .cpp a la liste des fichiers du projet). Avec <code class="language-plaintext highlighter-rouge">file(GLOB_RECURSE SOURCE_FILES src/*.cpp SRC)</code> le liste des fichiers figure dans la variable ‚ÄúSOURCE_FILES‚Äù. Si il vous faut exclure certains fichiers, vous pouvez utiliser :
<code class="language-plaintext highlighter-rouge">file(GLOB_RECURSE UNWANTED_FILES src/FichierAExclure.cpp SRC)
list (REMOVE_ITEM SOURCE_FILES ${UNWANTED_FILES})</code></p>

<p>Si vous √™tes fan des tests unitaires, CMake propose une fa√ßon agr√©able de lancer des tests avec :
<code class="language-plaintext highlighter-rouge">add_test (NAME NomDuTeste WORKING_DIRECTORY "${CMAKE_SOURCE_DIR}/repertoiredexecution" COMMAND "commande a executer")</code>
√áa vas de ‚Äúlancer un programme et v√©rifier qu‚Äôil EXIT_SUCCESS‚Äù √† ‚Äúv√©rifier que la sortie du programme contient cette expression‚Äù.</p>

<p>Chose utile, que ne fournissent pas les autotools, c‚Äôest une fa√ßon unifi√©e de g√®rer le num√©ro de version de l‚Äôapplication ; Toute les variables d‚Äôun CMakeListes peuvent √™tre utiliser pour g√©n√©rer des fichiers √† partir de templates (souvent le nom du fichier avec le suffixe .in). En pratique, on d√©finit VERSION_MAJOR et VERSION_MINOR, puis on g√©n√®re un Version.h, un doxyfile, et on utilise les valeurs pour g√©n√©rer les noms des biblioth√®ques export√©s. C‚Äôest simple, intuitif, et tr√®s bien expliqu√© dans le tutoriel. Faire une release se limite alors a changer le num√©ro de version dans un fichier, et de lancer la compilation pour obtenir les binaires et packages.</p>

<p>CMake dispose aussi d‚Äôun syst√®me de macros, pour faciliter la vie des maintainers, et l‚Äôon comprend donc que de plus en plus de projets tendent √† l‚Äôutiliser.</p>

<p>Un fichier de configuration emacs est disponible (depuis la doc de cmake) pour ajouter un ‚Äúcmake-mode‚Äù, et se charge avec, par exemple, <code class="language-plaintext highlighter-rouge">(load "~/.emacs.d/cmake-mode.el")</code>.</p>

<p>On peux aussi contr√¥ler la g√©n√©ration d‚Äôune documentation avec doxygen. Pour cela, on rajoute un CMakeListes dans un r√©pertoire /doc. On demande √† ce que doxygen soit pr√©sent via <code class="language-plaintext highlighter-rouge">find_package(Doxygen)</code>. On √©crit un fichier template doxygen.in de configuration, o√π les valeurs √† modifier sont de la forme @NOM_DUN_DEFINE@, et d√©finies dans le fichier de fonfiguration CMake par <code class="language-plaintext highlighter-rouge">set(NOM_DUN_DEFINE pou√Øc)</code>. Ensuite, on peut facilement ajouter une r√®gle ‚Äúmake doc‚Äù de la fa√ßon suivante :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if(DOXYGEN_FOUND)
  configure_file(${DOXYGEN_TEMPLATE_FILE}
    ${DOXYGEN_CONFIGURED_FILE}
    @ONLY
    )
  add_custom_target(doc
    ${DOXYGEN_EXECUTABLE}
    ${DOXYGEN_CONFIGURED_FILE}
    WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
    COMMENT "Generating API documentation with Doxygen" VERBATIM
    )
endif(DOXYGEN_FOUND)
</code></pre></div></div>
<p>o√π le @ONLY signifie que seul les mots entour√© d‚Äô@ seront remplac√© (Sinon, les ${SOMETHING} sont aussi affect√©s).</p>

<h2 id="conclusion-">Conclusion :</h2>

<p>Ce qu‚Äôil faut retenir, c‚Äôest que CMake est simple √† configurer, offre de nombreuses fonctionnalit√©s, et laisse la possibilit√© d‚Äôajouter celles manquantes. Beaucoup de gens sont encore habitu√© au ./configure, et sont effray√© par cette nouvelle fa√ßon d‚Äôaborder ce probl√®me. Pourtant, CMake est un r√©el gain de temps, et l‚Äôon voit des gros projets comme KDE changer de build system pour CMake.¬† On peux m√™me l‚Äôutiliser pour de minuscule projets (compiler les .cpp d‚Äôun dossier en un ex√©cutable, sans d√©pendances particuli√®res, se fait avec un fichier de configuration de 3 lignes), et je vous encourage justement √† le faire. Trois lignes pour avoir une gestion automatique des d√©pendances des .h, g√©n√©ration des makefiles, le tout multiplateforme, ce n‚Äôest pas cher pay√©.</p>

<h3 id="resources-">Resources :</h3>
<ul>
  <li><a href="http://en.wikipedia.org/wiki/CMake">http://en.wikipedia.org/wiki/CMake</a></li>
  <li><a href="http://www.cmake.org/cmake/help/cmake_tutorial.html">http://www.cmake.org/cmake/help/cmake_tutorial.html</a></li>
</ul>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/list-zipper-swift/">
            List Zipper applied to iOS swift
            <small>24 May 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/what-is-wrong-with-the-object-paradigm/">
            What is wrong with the object paradigm ?
            <small>17 Feb 2017</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/boost-property-tree/">
            How to use boost::property_tree to load and write JSON
            <small>21 Dec 2015</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

    
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-10762787-1', 'auto');
    ga('send', 'pageview');
</script>
    

    <footer class="footer">
  <hr/>
  <div class="container">
    <div class="row">
      <p class="text-muted col-sm-10 text-center">
            <span class="sidebar-nav-item small">Make a donation. üòá</span>
            <span class="sidebar-nav-item x-small">BTC: <a href="bitcoin:1JcME7DSCw8b83nEGFKUYTKE4LM8aX4dhJ">1JcME7DSCw8b83nEGFKUYTKE4LM8aX4dhJ</a></span>
            <span class="sidebar-nav-item x-small">ETH: <a href="ethereum:eA22ADf19f20D618D8EF66E4704C540A10708F1F">eA22ADf19f20D618D8EF66E4704C540A10708F1F</a></span>
      </p>
      <p class="col-sm-2">
        <a class="twitter-share-button col-sm"
           href="https://twitter.com/share"
           data-via="Zenol42">
          Tweet
        </a>
      </p>
    </div>
  </div>
</footer>

<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/bootstrap/js/vendor/jquery.min.js"><\/script>')</script>
<script src="/public/bootstrap/js/bootstrap.min.js"></script>

<!-- Twitter sharing button loader -->
<script>
  window.twttr = (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0],
      t = window.twttr || {};
    if (d.getElementById(id)) return t;
    js = d.createElement(s);
    js.id = id;
    js.src = "https://platform.twitter.com/widgets.js";
    fjs.parentNode.insertBefore(js, fjs);

    t._e = [];
    t.ready = function(f) {
      t._e.push(f);
    };

    return t;
  }(document, "script", "twitter-wjs"));
</script>

  </body>
</html>
